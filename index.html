<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineBattle: No Draws</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #ff4757;
            --success: #2ed573;
            --gold: #f1c40f;
            --dark: #1e272e;
            --glass: rgba(0, 0, 0, 0.6);
            --ui-glass: rgba(255, 255, 255, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0f1014;
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI TOP --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            z-index: 100; pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        }

        .top-row { display: flex; justify-content: space-between; width: 100%; padding: 0 20px; pointer-events: auto; }
        
        .gallery-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; font-size: 0.9em;
        }
        .gallery-btn:hover { background: rgba(255,255,255,0.2); }

        /* Score & Rank */
        .score-display { text-align: center; }
        .score-box {
            font-size: 2em; font-weight: 900; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            color: white; display: inline-block;
        }
        .rank-badge {
            font-size: 0.8em; text-transform: uppercase; letter-spacing: 2px;
            background: var(--primary); padding: 2px 10px; border-radius: 10px;
            margin-top: 5px; font-weight: 700; box-shadow: 0 0 10px var(--primary);
            opacity: 0; transition: opacity 0.5s;
        }
        .rank-badge.visible { opacity: 1; }
        
        .diversity-info {
            font-size: 0.7em; margin-top: 5px; opacity: 0.7;
            display: none; /* –ü–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –≤ endless mode */
        }

        /* Mode Switcher */
        .mode-container { pointer-events: auto; background: rgba(0,0,0,0.5); border-radius: 30px; padding: 4px; display: flex; gap: 5px; }
        .mode-btn {
            background: transparent; border: none; color: #aaa; padding: 8px 20px; border-radius: 25px;
            font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.8em; transition: 0.3s;
        }
        .mode-btn.active { background: white; color: black; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .mode-btn.daily { color: var(--gold); }
        .mode-btn.daily.active { background: var(--gold); color: black; box-shadow: 0 0 15px var(--gold); }

        /* --- GAME AREA --- */
        .game-container { display: flex; width: 100%; height: 100%; position: relative; }

        .card {
            flex: 1; height: 100%; position: relative; cursor: pointer;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; text-align: center;
        }

        .card-bg {
            position: absolute; inset: -30px; background-size: cover; background-position: center;
            transition: transform 0.1s; z-index: 0; filter: brightness(0.6);
        }
        .card::after {
            content: ''; position: absolute; inset: 0; z-index: 1;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.9));
            transition: background 0.3s;
        }
        .card:hover .card-bg { filter: brightness(0.8); transform: scale(1.02); }

        .card-content { position: relative; z-index: 10; padding: 20px; width: 90%; pointer-events: none; }
        
        .movie-title {
            font-size: 2.2em; font-weight: 900; text-shadow: 0 4px 20px rgba(0,0,0,1);
            margin-bottom: 10px; opacity: 0; transform: translateY(20px); transition: 0.5s;
        }

        .movie-year {
            display: inline-block; padding: 5px 12px; background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px); border-radius: 8px; font-weight: 700; margin-bottom: 20px;
            transition: 0.3s;
        }
        .blur-text { filter: blur(8px); background: rgba(255,255,255,0.3); user-select: none; }

        .rating-val { font-size: 5em; font-weight: 900; color: var(--success); text-shadow: 0 0 30px rgba(0,0,0,0.5); }
        
        .range-hint {
            font-size: 1.5em; font-weight: 700; color: var(--gold);
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 10px; border: 2px solid var(--gold);
            display: none; margin-top: 10px; animation: popIn 0.3s;
        }

        .vs-badge {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: white; color: black; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-weight: 900; z-index: 50;
            pointer-events: none;
        }

        /* --- LIFELINES --- */
        .lifelines-container {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 15px;
            z-index: 90; pointer-events: none;
        }
        .lifeline-btn {
            pointer-events: auto; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 12px 20px; border-radius: 15px; cursor: pointer;
            backdrop-filter: blur(10px); font-weight: 700; transition: 0.3s; display: flex; flex-direction: column; align-items: center;
            min-width: 80px;
        }
        .lifeline-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-5px); }
        .lifeline-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .lifeline-icon { font-size: 1.5em; margin-bottom: 2px; }
        .lifeline-label { font-size: 0.7em; text-transform: uppercase; }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed; inset: 0; background: #0f1014; z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.4s;
        }
        .overlay.hidden { opacity: 0; pointer-events: none; }

        .gallery-modal {
            position: fixed; inset: 0; background: rgba(15, 16, 20, 0.95); z-index: 150;
            padding: 20px; display: none; flex-direction: column;
        }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;
            overflow-y: auto; padding-bottom: 50px;
        }
        .gallery-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 2/3; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item:hover { transform: scale(1.05); transition: 0.2s; z-index: 2; box-shadow: 0 0 15px var(--success); }

        .share-box {
            background: #1e272e; padding: 30px; border-radius: 20px; text-align: center;
            border: 1px solid rgba(255,255,255,0.1); max-width: 90%;
        }
        .share-grid { font-family: monospace; font-size: 1.5em; letter-spacing: 5px; margin: 20px 0; }
        .action-btn {
            background: var(--primary); border: none; padding: 15px 40px; border-radius: 30px;
            color: white; font-weight: 900; cursor: pointer; margin-top: 10px; font-size: 1.1em;
        }
        
        .visible { opacity: 1 !important; transform: translateY(0) !important; }
        .winner::after { background: rgba(46, 213, 115, 0.7); }
        .loser::after { background: rgba(255, 71, 87, 0.7); }

        .error-message {
            background: rgba(255, 71, 87, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin: 20px;
            max-width: 500px;
        }

        @media (max-width: 768px) {
            .game-container { flex-direction: column; }
            .rating-val { font-size: 3em; }
            .movie-title { font-size: 1.5em; }
            .lifelines-container { bottom: 10px; gap: 10px; }
            .lifeline-btn { padding: 8px 15px; min-width: 60px; }
        }
    </style>
</head>
<body>

    <div class="ui-layer">
        <div class="top-row">
            <button class="gallery-btn" onclick="toggleGallery()">
                <span>üñºÔ∏è</span> Gallery
            </button>
            <div class="score-display">
                <div class="score-box" id="score">0</div>
                <div class="rank-badge" id="rankBadge">NOVICE</div>
                <div class="diversity-info" id="diversityInfo">Pool: 0 movies</div>
            </div>
            <div style="width:80px"></div>
        </div>

        <div class="mode-container">
            <button class="mode-btn active" id="btnEndless" onclick="setMode('endless')">Endless</button>
            <button class="mode-btn daily" id="btnDaily" onclick="setMode('daily')">Daily üìÖ</button>
        </div>
    </div>

    <div class="game-container">
        <div class="vs-badge">VS</div>

        <div class="card" id="cardLeft" onclick="handleChoice('left')">
            <div class="card-bg" id="bgLeft"></div>
            <div class="card-content">
                <div class="movie-title" id="titleLeft">...</div>
                <div class="movie-year blur-text" id="yearLeft">....</div>
                <div class="rating-val" id="valLeft">?</div>
            </div>
        </div>

        <div class="card" id="cardRight" onclick="handleChoice('right')">
            <div class="card-bg" id="bgRight"></div>
            <div class="card-content">
                <div class="movie-title" id="titleRight">...</div>
                <div class="movie-year blur-text" id="yearRight">....</div>
                <div class="rating-val" id="valRight">?</div>
                <div class="range-hint" id="rangeHint">6.5 - 7.5</div>
            </div>
        </div>
    </div>

    <div class="lifelines-container">
        <button class="lifeline-btn" id="btn5050" onclick="useLifeline('5050')">
            <span class="lifeline-icon">‚öñÔ∏è</span>
            <span class="lifeline-label">50/50</span>
        </button>
        <button class="lifeline-btn" id="btnSkip" onclick="useLifeline('skip')">
            <span class="lifeline-icon">‚è≠Ô∏è</span>
            <span class="lifeline-label">Skip</span>
        </button>
        <button class="lifeline-btn" id="btnYear" onclick="useLifeline('year')">
            <span class="lifeline-icon">üìÖ</span>
            <span class="lifeline-label">Year</span>
        </button>
    </div>

    <div class="overlay" id="overlay">
        <h2 id="overlayText" style="font-size: 2em; margin-bottom:20px">Loading...</h2>
        
        <div id="shareSection" class="share-box" style="display:none">
            <h3>DAILY CHALLENGE COMPLETED</h3>
            <div class="share-grid" id="shareGrid">‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú</div>
            <button class="action-btn" onclick="shareResult()">SHARE RESULT üì§</button>
            <p style="margin-top:10px; font-size:0.8em; opacity:0.6" id="shareFeedback"></p>
        </div>

        <button class="action-btn" id="btnRestart" onclick="initGame()" style="display:none">PLAY AGAIN</button>
    </div>

    <div class="gallery-modal" id="galleryModal">
        <div class="gallery-header">
            <h2>üèÜ Victory Gallery</h2>
            <button onclick="toggleGallery()" style="background:none; border:none; color:white; font-size:1.5em; cursor:pointer">‚úï</button>
        </div>
        <div class="gallery-grid" id="galleryGrid"></div>
    </div>

    <script>
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –≤–∞—à –≤–ª–∞—Å–Ω–∏–π API –∫–ª—é—á –∑ https://www.themoviedb.org/settings/api
        const API_KEY = 'd7397b9320954b044b1b8d22041d6bab';
        
        // Seeded RNG –¥–ª—è daily mode
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        let state = {
            mode: 'endless',
            score: 0,
            round: 0,
            dailyResults: [],
            lifelines: { '5050': true, 'skip': true, 'year': true },
            leftItem: null,
            rightItem: null,
            locked: false,
            rng: Math.random,
            fetchAttempts: 0,
            maxFetchAttempts: 50,
            dailyMovies: [], // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ñ—ñ–ª—å–º—ñ–≤ daily mode
            usedMovieIds: new Set(), // –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏—Ö —Ñ—ñ–ª—å–º—ñ–≤
            moviePool: [] // –ü—É–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ñ—ñ–ª—å–º—ñ–≤ –¥–ª—è endless mode
        };

        // –†—ñ–∑–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–∞ –µ–ø–æ—Ö–∏ –¥–ª—è —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω–æ—Å—Ç—ñ
        const MOVIE_CATEGORIES = [
            { endpoint: 'popular', weight: 3 },
            { endpoint: 'top_rated', weight: 3 },
            { endpoint: 'now_playing', weight: 2 },
            { endpoint: 'upcoming', weight: 1 }
        ];

        const YEAR_RANGES = [
            { start: 2020, end: 2025, weight: 3 },
            { start: 2010, end: 2019, weight: 3 },
            { start: 2000, end: 2009, weight: 2 },
            { start: 1990, end: 1999, weight: 2 },
            { start: 1980, end: 1989, weight: 1 },
            { start: 1970, end: 1979, weight: 1 }
        ];

        function getTodaySeed() {
            const date = new Date();
            return parseInt(`${date.getFullYear()}${String(date.getMonth()+1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`);
        }

        function setMode(mode) {
            if(state.mode === mode) return;
            state.mode = mode;
            document.getElementById('btnEndless').classList.toggle('active', mode === 'endless');
            document.getElementById('btnDaily').classList.toggle('active', mode === 'daily');
            initGame();
        }

        async function initGame() {
            const overlay = document.getElementById('overlay');
            const txt = document.getElementById('overlayText');
            
            state.score = 0;
            state.round = 0;
            state.dailyResults = [];
            state.lifelines = { '5050': true, 'skip': true, 'year': true };
            state.fetchAttempts = 0;
            state.dailyMovies = [];
            state.usedMovieIds = new Set(); // –û—á–∏—â–∞—î–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ñ—ñ–ª—å–º–∏
            state.moviePool = [];
            
            updateLifelinesUI();
            updateScoreUI();
            
            document.getElementById('shareSection').style.display = 'none';
            document.getElementById('btnRestart').style.display = 'none';
            txt.innerText = 'Loading Movies...';
            overlay.classList.remove('hidden');

            if(state.mode === 'daily') {
                state.rng = mulberry32(getTodaySeed());
                try {
                    await loadDailyMovies();
                } catch (error) {
                    showError('Failed to load daily challenge. Please try again.');
                    return;
                }
            } else {
                state.rng = Math.random;
                try {
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø—É–ª —Ñ—ñ–ª—å–º—ñ–≤ –¥–ª—è endless mode
                    txt.innerText = 'Loading Movie Collection...';
                    state.moviePool = await loadMoviePool();
                    if (state.moviePool.length < 20) {
                        throw new Error('Not enough movies in pool');
                    }
                } catch (error) {
                    console.error('Error loading pool:', error);
                    showError('Failed to load movie collection. Please try again.');
                    return;
                }
            }

            try {
                await loadRound(true);
                overlay.classList.add('hidden');
            } catch (error) {
                showError('Failed to load movies. Please check your internet connection and try again.');
            }
        }

        // –í–∏–±—ñ—Ä –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–∞–≥–∏
        function selectWeightedCategory(categories) {
            const totalWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);
            let random = state.rng() * totalWeight;
            
            for (const cat of categories) {
                random -= cat.weight;
                if (random <= 0) return cat;
            }
            return categories[0];
        }

        async function fetchMovie() {
            try {
                // –í–∏–±–∏—Ä–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
                const category = selectWeightedCategory(MOVIE_CATEGORIES);
                const yearRange = selectWeightedCategory(YEAR_RANGES);
                
                const page = Math.floor(state.rng() * 20) + 1;
                
                // –î–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –ø–æ —Ä–æ–∫–∞–º –¥–ª—è –±—ñ–ª—å—à–æ—ó —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω–æ—Å—Ç—ñ
                const params = new URLSearchParams({
                    api_key: API_KEY,
                    language: 'en-US',
                    page: page.toString(),
                    'vote_count.gte': '100'
                });
                
                // –î–ª—è –¥–µ—è–∫–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –¥–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –ø–æ —Ä–æ–∫–∞–º
                if (category.endpoint === 'discover') {
                    params.append('primary_release_date.gte', `${yearRange.start}-01-01`);
                    params.append('primary_release_date.lte', `${yearRange.end}-12-31`);
                    params.append('sort_by', 'vote_average.desc');
                }
                
                const endpoint = category.endpoint === 'discover' ? 
                    'discover/movie' : `movie/${category.endpoint}`;
                
                const res = await fetch(`https://api.themoviedb.org/3/${endpoint}?${params}`);
                
                if (!res.ok) {
                    throw new Error(`API error: ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error('No movies found');
                }
                
                // –®–∞—Ñ–ª–∏–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
                const candidates = data.results.sort(() => 0.5 - state.rng());
                
                // –®—É–∫–∞—î–º–æ –≤–∞–ª—ñ–¥–Ω–∏–π —Ñ—ñ–ª—å–º, —è–∫–∏–π —â–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è
                const valid = candidates.find(m => 
                    m.vote_count > 100 && 
                    m.backdrop_path && 
                    m.poster_path &&
                    m.vote_average > 0 &&
                    m.release_date &&
                    !state.usedMovieIds.has(m.id) // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è
                );
                
                if (!valid) {
                    if (state.fetchAttempts < state.maxFetchAttempts) {
                        state.fetchAttempts++;
                        return fetchMovie();
                    }
                    throw new Error('Could not find valid movie after multiple attempts');
                }
                
                return valid;
            } catch (error) {
                console.error('Error fetching movie:', error);
                if (state.fetchAttempts < state.maxFetchAttempts) {
                    state.fetchAttempts++;
                    return fetchMovie();
                }
                throw error;
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—É–ª—É —Ñ—ñ–ª—å–º—ñ–≤ –¥–ª—è endless mode
        async function loadMoviePool() {
            const pool = [];
            const categories = ['popular', 'top_rated', 'now_playing'];
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ 2 —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑ –∫–æ–∂–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
            for (const category of categories) {
                for (let page = 1; page <= 2; page++) {
                    try {
                        const res = await fetch(
                            `https://api.themoviedb.org/3/movie/${category}?api_key=${API_KEY}&language=en-US&page=${page}`
                        );
                        if (res.ok) {
                            const data = await res.json();
                            const valid = data.results.filter(m => 
                                m.vote_count > 100 && 
                                m.backdrop_path && 
                                m.poster_path &&
                                m.vote_average > 0 &&
                                m.release_date
                            );
                            pool.push(...valid);
                        }
                    } catch (error) {
                        console.error('Error loading pool:', error);
                    }
                }
            }
            
            // –î–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å–º–∏ –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–µ—Å—è—Ç–∏–ª—ñ—Ç—å
            const decades = [
                { year: '2020-01-01', endYear: '2024-12-31' },
                { year: '2010-01-01', endYear: '2019-12-31' },
                { year: '2000-01-01', endYear: '2009-12-31' },
                { year: '1990-01-01', endYear: '1999-12-31' }
            ];
            
            for (const decade of decades) {
                try {
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&language=en-US&sort_by=vote_average.desc&vote_count.gte=100&primary_release_date.gte=${decade.year}&primary_release_date.lte=${decade.endYear}&page=1`
                    );
                    if (res.ok) {
                        const data = await res.json();
                        const valid = data.results.filter(m => 
                            m.backdrop_path && m.poster_path && m.vote_average > 0
                        );
                        pool.push(...valid.slice(0, 10)); // –ë–µ—Ä–µ–º–æ —Ç–æ–ø-10 –∑ –∫–æ–∂–Ω–æ–≥–æ –¥–µ—Å—è—Ç–∏–ª—ñ—Ç—Ç—è
                    }
                } catch (error) {
                    console.error('Error loading decade:', error);
                }
            }
            
            // –ü–µ—Ä–µ–º—ñ—à—É—î–º–æ –ø—É–ª
            return pool.sort(() => 0.5 - state.rng());
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—ñ–≤ –¥–ª—è daily mode - –æ–¥–Ω–∞–∫–æ–≤—ñ –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        async function loadDailyMovies() {
            state.dailyMovies = [];
            const tempRng = mulberry32(getTodaySeed());
            
            const allMovies = [];
            const categories = ['popular', 'top_rated', 'now_playing'];
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑ —Ä—ñ–∑–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
            for (const category of categories) {
                const page = Math.floor(tempRng() * 10) + 1;
                try {
                    const res = await fetch(
                        `https://api.themoviedb.org/3/movie/${category}?api_key=${API_KEY}&language=en-US&page=${page}`
                    );
                    if (res.ok) {
                        const data = await res.json();
                        const valid = data.results.filter(m => 
                            m.vote_count > 100 && 
                            m.backdrop_path && 
                            m.poster_path &&
                            m.vote_average > 0 &&
                            m.release_date
                        );
                        allMovies.push(...valid);
                    }
                } catch (error) {
                    console.error('Error loading category:', category, error);
                }
            }
            
            // –î–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å–º–∏ –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–µ—Å—è—Ç–∏–ª—ñ—Ç—å –¥–ª—è —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω–æ—Å—Ç—ñ
            const decades = [
                { start: 2015, end: 2024 },
                { start: 2005, end: 2014 },
                { start: 1995, end: 2004 },
                { start: 1985, end: 1994 }
            ];
            
            for (const decade of decades) {
                try {
                    const res = await fetch(
                        `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&language=en-US&sort_by=vote_average.desc&vote_count.gte=100&primary_release_date.gte=${decade.start}-01-01&primary_release_date.lte=${decade.end}-12-31&page=1`
                    );
                    if (res.ok) {
                        const data = await res.json();
                        const valid = data.results.filter(m => 
                            m.backdrop_path && m.poster_path && m.vote_average > 0 && m.release_date
                        );
                        allMovies.push(...valid);
                    }
                } catch (error) {
                    console.error('Error loading decade:', decade, error);
                }
            }
            
            if (allMovies.length < 30) {
                throw new Error('Not enough movies loaded for daily mode');
            }
            
            // –ü–µ—Ä–µ–º—ñ—à—É—î–º–æ –∑ seeded RNG
            for (let i = allMovies.length - 1; i > 0; i--) {
                const j = Math.floor(tempRng() * (i + 1));
                [allMovies[i], allMovies[j]] = [allMovies[j], allMovies[i]];
            }
            
            // –í–∏–±–∏—Ä–∞—î–º–æ 20 —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Ñ—ñ–ª—å–º—ñ–≤, —É–Ω–∏–∫–∞—é—á–∏ –Ω—ñ—á–∏—ó—Ö
            const selected = [];
            const usedIds = new Set();
            const usedRatings = new Set();
            
            for (const movie of allMovies) {
                if (selected.length >= 20) break;
                
                const rating = parseFloat(movie.vote_average.toFixed(1));
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å ID —Ç–∞ —Ä–µ–π—Ç–∏–Ω–≥—É
                if (!usedIds.has(movie.id) && !usedRatings.has(rating)) {
                    selected.push(movie);
                    usedIds.add(movie.id);
                    usedRatings.add(rating);
                }
            }
            
            if (selected.length < 20) {
                throw new Error('Could not find enough unique movies for daily challenge');
            }
            
            state.dailyMovies = selected;
            return selected;
        }

        // --- DRAW PROTECTION LOGIC ---
        function getVal(item) {
            return item ? parseFloat(item.vote_average.toFixed(1)) : 0;
        }

        function isSameValue(item1, item2) {
            if (!item1 || !item2) return false;
            // –°—Ç—Ä–æ–≥–µ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –Ω—ñ—á–∏—ó–º
            return getVal(item1) === getVal(item2);
        }

        async function loadRound(isFirst) {
            state.locked = true;
            state.fetchAttempts = 0;
            resetCardStyles();
            
            if (state.mode === 'daily' && state.round >= 10) {
                endDailyGame();
                return;
            }

            try {
                if (state.mode === 'daily') {
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–µ—Ä–µ–¥–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —Ñ—ñ–ª—å–º–∏
                    const idx = state.round * 2;
                    if (idx + 1 >= state.dailyMovies.length) {
                        throw new Error('Not enough movies for daily challenge');
                    }
                    state.leftItem = state.dailyMovies[idx];
                    state.rightItem = state.dailyMovies[idx + 1];
                    
                    // –î–æ–¥–∞—î–º–æ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏—Ö
                    state.usedMovieIds.add(state.leftItem.id);
                    state.usedMovieIds.add(state.rightItem.id);
                } else {
                    // Endless mode
                    if (isFirst) {
                        // –ü–µ—Ä—à–∏–π —Ä–∞—É–Ω–¥ - –≤–∏–±–∏—Ä–∞—î–º–æ 2 —Ñ—ñ–ª—å–º–∏ –∑ –ø—É–ª—É
                        let m1 = getRandomMovieFromPool();
                        let m2 = getRandomMovieFromPool();
                        
                        let attempts = 0;
                        while ((!m1 || !m2 || m1.id === m2.id || isSameValue(m1, m2)) && attempts < 20) {
                            m2 = getRandomMovieFromPool();
                            if(!m1) m1 = getRandomMovieFromPool();
                            attempts++;
                        }
                        
                        if (attempts >= 20) {
                            throw new Error('Could not find suitable movie pair');
                        }
                        
                        state.leftItem = m1;
                        state.rightItem = m2;
                        state.usedMovieIds.add(m1.id);
                        state.usedMovieIds.add(m2.id);
                    } else {
                        // –ù–∞—Å—Ç—É–ø–Ω—ñ —Ä–∞—É–Ω–¥–∏ - –ª—ñ–≤–∏–π —Ñ—ñ–ª—å–º –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è
                        let m2 = getRandomMovieFromPool();
                        let attempts = 0;
                        
                        while ((!m2 || m2.id === state.leftItem.id || isSameValue(state.leftItem, m2)) && attempts < 20) {
                            m2 = getRandomMovieFromPool();
                            attempts++;
                        }
                        
                        if (attempts >= 20) {
                            // –Ø–∫—â–æ –ø—É–ª –≤–∏—á–µ—Ä–ø–∞–≤—Å—è, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–æ–≤–∏–π
                            console.log('Pool exhausted, reloading...');
                            state.usedMovieIds = new Set([state.leftItem.id]); // –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –ª—ñ–≤–∏–π —Ñ—ñ–ª—å–º
                            state.moviePool = await loadMoviePool();
                            m2 = getRandomMovieFromPool();
                            
                            if (!m2 || m2.id === state.leftItem.id || isSameValue(state.leftItem, m2)) {
                                throw new Error('Could not find suitable movie');
                            }
                        }
                        
                        state.rightItem = m2;
                        state.usedMovieIds.add(m2.id);
                    }
                }

                renderCards();
                state.locked = false;
            } catch (error) {
                console.error('Error in loadRound:', error);
                showError('Failed to load movies. Click "Play Again" to retry.');
                document.getElementById('btnRestart').style.display = 'inline-block';
            }
        }

        // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π —Ñ—ñ–ª—å–º –∑ –ø—É–ª—É, —è–∫–∏–π —â–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è
        function getRandomMovieFromPool() {
            if (state.moviePool.length === 0) return null;
            
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ñ—ñ–ª—å–º–∏
            const available = state.moviePool.filter(m => !state.usedMovieIds.has(m.id));
            
            if (available.length === 0) {
                // –Ø–∫—â–æ –≤—Å—ñ —Ñ—ñ–ª—å–º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ, —Å–∫–∏–¥–∞—î–º–æ (–∫—Ä—ñ–º –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ª—ñ–≤–æ–≥–æ)
                const currentLeftId = state.leftItem ? state.leftItem.id : null;
                state.usedMovieIds = new Set(currentLeftId ? [currentLeftId] : []);
                return state.moviePool[Math.floor(state.rng() * state.moviePool.length)];
            }
            
            // –í–∏–±–∏—Ä–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –∑ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö
            return available[Math.floor(state.rng() * available.length)];
        }

        function renderCards() {
            updateCard('Left', state.leftItem);
            updateCard('Right', state.rightItem);
            document.getElementById('rangeHint').style.display = 'none';
            // –ë–ª—é—Ä–∏–º–æ –æ–±–∏–¥–≤—ñ –¥–∞—Ç–∏
            document.getElementById('yearLeft').classList.add('blur-text');
            document.getElementById('yearRight').classList.add('blur-text');
        }

        function updateCard(side, item) {
            const bgUrl = item.backdrop_path ? 
                `url('https://image.tmdb.org/t/p/original${item.backdrop_path}')` :
                `url('https://via.placeholder.com/1920x1080/1e272e/ffffff?text=${encodeURIComponent(item.title)}')`;
            
            document.getElementById(`bg${side}`).style.backgroundImage = bgUrl;
            
            const title = document.getElementById(`title${side}`);
            title.innerText = item.title || 'Unknown Title';
            title.classList.remove('visible');
            void title.offsetWidth; 
            setTimeout(() => title.classList.add('visible'), 50);

            const year = (item.release_date || '').split('-')[0] || 'Unknown';
            document.getElementById(`year${side}`).innerText = year;
            
            const showRating = (state.mode === 'endless' && state.score > 0 && side === 'Left');
            document.getElementById(`val${side}`).innerText = showRating ? item.vote_average.toFixed(1) : '?';
        }

        function handleChoice(side) {
            if (state.locked) return;
            state.locked = true;

            const lVal = getVal(state.leftItem);
            const rVal = getVal(state.rightItem);
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–µ—Ä–µ–º–æ–∂—Ü—è (>=  –æ–±—Ä–æ–±–ª—è—î —Ä—ñ–¥–∫—ñ—Å–Ω—ñ –≤–∏–ø–∞–¥–∫–∏ –Ω—ñ—á–∏—ó—Ö)
            const userWon = (side === 'left' && lVal >= rVal) || (side === 'right' && rVal >= lVal);

            document.getElementById('valLeft').innerText = lVal.toFixed(1);
            document.getElementById('valRight').innerText = rVal.toFixed(1);
            // –†–æ–∑–±–ª—é—Ä—é—î–º–æ –æ–±–∏–¥–≤—ñ –¥–∞—Ç–∏
            document.getElementById('yearLeft').classList.remove('blur-text');
            document.getElementById('yearRight').classList.remove('blur-text');

            const lCard = document.getElementById('cardLeft');
            const rCard = document.getElementById('cardRight');

            setTimeout(() => {
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–µ—Ä–µ–º–æ–∂—Ü—è
                if (lVal >= rVal) { 
                    lCard.classList.add('winner'); 
                    rCard.classList.add('loser'); 
                } else { 
                    rCard.classList.add('winner'); 
                    lCard.classList.add('loser'); 
                }

                if (userWon) {
                    state.score++;
                    state.dailyResults.push('win');
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                    addToGallery(lVal >= rVal ? state.leftItem : state.rightItem);
                    
                    if(state.mode === 'endless') {
                        // –í endless mode –ø–µ—Ä–µ–º–æ–∂–µ—Ü—å —Å—Ç–∞—î –ª—ñ–≤–æ—é –∫–∞—Ä—Ç–∫–æ—é
                        if (rVal > lVal) state.leftItem = state.rightItem;
                        setTimeout(() => loadRound(false), 2000);
                    } else {
                        state.round++;
                        setTimeout(() => loadRound(false), 2000);
                    }
                } else {
                    state.dailyResults.push('lose');
                    if(state.mode === 'endless') {
                        setTimeout(gameOver, 2000);
                    } else {
                        state.round++;
                        setTimeout(() => loadRound(false), 2000);
                    }
                }
                updateScoreUI();
            }, 500);
        }

        function useLifeline(type) {
            if (state.locked || !state.lifelines[type]) return;
            
            state.lifelines[type] = false;
            updateLifelinesUI();

            if (type === '5050') {
                const rVal = state.rightItem.vote_average;
                const min = Math.max(0, rVal - 0.5);
                const max = Math.min(10, rVal + 0.5);
                document.getElementById('rangeHint').innerText = `${min.toFixed(1)} - ${max.toFixed(1)}`;
                document.getElementById('rangeHint').style.display = 'block';
            } else if (type === 'skip') {
                state.locked = true;
                
                if (state.mode === 'daily') {
                    // –í daily mode –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–∞—É–Ω–¥
                    state.round++;
                    setTimeout(() => loadRound(false), 500);
                } else {
                    // –í endless mode –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–æ–≤–∏–π —Ä–∞—É–Ω–¥
                    setTimeout(() => loadRound(true), 500);
                }
            } else if (type === 'year') {
                // –†–æ–∑–±–ª—é—Ä—é—î–º–æ –æ–±–∏–¥–≤—ñ –¥–∞—Ç–∏
                document.getElementById('yearLeft').classList.remove('blur-text');
                document.getElementById('yearRight').classList.remove('blur-text');
            }
        }

        function updateLifelinesUI() {
            document.getElementById('btn5050').disabled = !state.lifelines['5050'];
            document.getElementById('btnSkip').disabled = !state.lifelines['skip'];
            document.getElementById('btnYear').disabled = !state.lifelines['year'];
        }

        function updateScoreUI() {
            document.getElementById('score').innerText = state.score;
            const badge = document.getElementById('rankBadge');
            let rank = "NOVICE"; 
            let color = "#bdc3c7";
            
            if (state.score >= 5) { rank = "FANBOY"; color = "#3498db"; }
            if (state.score >= 10) { rank = "CRITIC"; color = "#9b59b6"; }
            if (state.score >= 20) { rank = "DIRECTOR"; color = "#e67e22"; }
            if (state.score >= 50) { rank = "TARANTINO"; color = "#e74c3c"; }
            
            badge.innerText = rank; 
            badge.style.background = color; 
            badge.style.boxShadow = `0 0 10px ${color}`; 
            badge.classList.add('visible');
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ –ø—Ä–æ —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω—ñ—Å—Ç—å –≤ endless mode
            const diversityInfo = document.getElementById('diversityInfo');
            if (state.mode === 'endless' && state.moviePool.length > 0) {
                const available = state.moviePool.filter(m => !state.usedMovieIds.has(m.id)).length;
                diversityInfo.innerText = `üé¨ ${available}/${state.moviePool.length} fresh`;
                diversityInfo.style.display = 'block';
            } else {
                diversityInfo.style.display = 'none';
            }
        }

        function resetCardStyles() {
            document.getElementById('cardLeft').className = 'card';
            document.getElementById('cardRight').className = 'card';
            
            const leftVal = (state.mode === 'endless' && state.score > 0 && state.leftItem) ? 
                state.leftItem.vote_average.toFixed(1) : '?';
            document.getElementById('valLeft').innerText = leftVal;
            document.getElementById('valRight').innerText = '?';
            
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ blur –Ω–∞ –¥–∞—Ç–∏ (—è–∫—â–æ year lifeline –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ)
            if (state.lifelines['year']) {
                document.getElementById('yearLeft').classList.add('blur-text');
                document.getElementById('yearRight').classList.add('blur-text');
            }
        }

        function endDailyGame() {
            const overlay = document.getElementById('overlay');
            const shareBox = document.getElementById('shareSection');
            const grid = document.getElementById('shareGrid');
            const txt = document.getElementById('overlayText');
            
            txt.innerText = 'DAILY CHALLENGE COMPLETE';
            
            let gridStr = '';
            state.dailyResults.forEach((res, i) => {
                gridStr += res === 'win' ? 'üü©' : 'üü•';
                if (i === 4) gridStr += '\n';
            });
            
            grid.innerText = gridStr;
            shareBox.style.display = 'block';
            overlay.classList.remove('hidden');
        }

        function shareResult() {
            const date = new Date().toISOString().split('T')[0];
            const squares = document.getElementById('shareGrid').innerText;
            const text = `üé¨ Movie Battle Daily ${date}\nScore: ${state.score}/10\n\n${squares}\n\nPlay CineBattle!`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    const fb = document.getElementById('shareFeedback');
                    fb.innerText = 'COPIED TO CLIPBOARD!';
                    setTimeout(() => fb.innerText = '', 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Could not copy to clipboard. Please copy manually:\n\n' + text);
                });
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
                alert('Copy this text:\n\n' + text);
            }
        }

        function gameOver() {
            const overlay = document.getElementById('overlay');
            document.getElementById('overlayText').innerHTML = `GAME OVER<br>Score: ${state.score}`;
            document.getElementById('btnRestart').style.display = 'inline-block';
            overlay.classList.remove('hidden');
        }

        function showError(message) {
            const overlay = document.getElementById('overlay');
            const txt = document.getElementById('overlayText');
            txt.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
            document.getElementById('btnRestart').style.display = 'inline-block';
            overlay.classList.remove('hidden');
        }

        function addToGallery(movie) {
            try {
                let gallery = JSON.parse(localStorage.getItem('cineGallery')) || [];
                if (!gallery.find(m => m.id === movie.id)) {
                    gallery.unshift({ 
                        id: movie.id, 
                        poster: movie.poster_path, 
                        title: movie.title 
                    });
                    if (gallery.length > 50) gallery.pop();
                    localStorage.setItem('cineGallery', JSON.stringify(gallery));
                }
            } catch (error) {
                console.error('Error saving to gallery:', error);
            }
        }

        function toggleGallery() {
            const modal = document.getElementById('galleryModal');
            const grid = document.getElementById('galleryGrid');
            
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                try {
                    const gallery = JSON.parse(localStorage.getItem('cineGallery')) || [];
                    if (gallery.length === 0) {
                        grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding:40px;">No movies yet. Win some battles to fill your gallery!</p>';
                    } else {
                        grid.innerHTML = gallery.map(m => `
                            <div class="gallery-item" title="${m.title}">
                                <img src="https://image.tmdb.org/t/p/w200${m.poster}" 
                                     alt="${m.title}"
                                     loading="lazy"
                                     onerror="this.src='https://via.placeholder.com/200x300/1e272e/ffffff?text=No+Image'">
                            </div>
                        `).join('');
                    }
                    modal.style.display = 'flex';
                } catch (error) {
                    console.error('Error loading gallery:', error);
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">Error loading gallery</p>';
                }
            }
        }

        // Parallax –µ—Ñ–µ–∫—Ç –¥–ª—è —Ñ–æ–Ω—É
        document.addEventListener('mousemove', (e) => {
            if (window.innerWidth < 768) return;
            const x = (window.innerWidth - e.pageX * 2) / 100;
            const y = (window.innerHeight - e.pageY * 2) / 100;
            
            const bgLeft = document.getElementById('bgLeft');
            const bgRight = document.getElementById('bgRight');
            
            if (bgLeft) bgLeft.style.transform = `scale(1.1) translate(${x}px, ${y}px)`;
            if (bgRight) bgRight.style.transform = `scale(1.1) translate(${-x}px, ${-y}px)`;
        });

        // –ó–∞–ø—É—Å–∫ –≥—Ä–∏
        window.onload = initGame;
    </script>
</body>
</html>
